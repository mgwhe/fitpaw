    <script>
        function openMapDialog() {
          $("#mapModal").dialog({
                autoOpen: false, 
                modal: true, 
                title: 'Modal', 
                width: 'auto', 
                height: 'auto', 
                buttons: { "Cancel": function () { $(this).dialog("close"); } },
            }).dialog('open');
            return false;
        }
        </script>
    
    <div class="col-sm-6"> 
   <!-- <iframe id="mapFrame" onload="doMapLoad()"></iframe>-->
 </div>
 <div class="col-sm-6"> 
    <p>Click the button to get your coordinates!!</p>

    <button id="StartButton" onclick="startTracking()">Start</button>
    <button id="StopButton" onclick="stopTracking()">Stop</button>
    <button id ="modal-button" type ="button" data-toggle ="modal" data-target ="#mapModal">View </button>
    <p id="demo"></p>
   
</div>
<script>
    
    var distanceTotal =0;
    var startTime, endTime;
    var duarationInSecs=0;

    function coordinate(x, y) {
        this.x = x;
        this.y = y;
    }
    
    var timerRef;
    var locs = new Array();

    var x = document.getElementById("demo");
    
    function startTracking(){
        //dont wait for timer - start instantly
        getLocation();
         
        timerRef = setInterval(() => {
        getLocation();
        }, 4000); //milliseconds

        startTime = Date.now();
    }

    function stopTracking(){
        clearInterval(timerRef);

        const millis = Date.now() - startTime
       // alert("Time now:"+Date.now()+" Time at start: "+startTime);

        duarationInSecs = Math.floor(millis/1000);

        distanceTotal = calculateTotalDistance();

        alert("RESULT Total time (secs):" + duarationInSecs +" Total distance: "+distanceTotal);
        
        //add API to upload activity
        var stringEndpoint = "/api/track/"+position.coords.latitude+ ","+ position.coords.longitude;
        
        /*
        $.get(stringEndpoint, (results ={}) =>{                  
            let data = results.data;
            if (!data || !data.location){                
                return;
            }
            else{
                    
            }
        }) //get
        */
    }    

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(processPosition);
      } else { 
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }
    
    function processPosition(position) {
        x.innerHTML = "Date: "+ Date() + "<br>Latitude: " + position.coords.latitude +
        "<br>Longitude: " + position.coords.longitude;
        locs.push(new coordinate(position.coords.latitude,position.coords.longitude));
          
    } //processPosition

    function calculateTotalDistance()
    {
        var tmpDistance =0;

        for(i=0;i<locs.length;i++)
        {
            if((i+1)<locs.length)
            {
                tmpDistance += getDistanceFromLatLonInKm(
                    locs[i].x,locs[i].y,
                    locs[i+1].x, locs[i+1].y
                );
               
            }
        }
        return tmpDistance;
    }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; // Radius of the earth in km
        var dLat = deg2rad(lat2-lat1);  // deg2rad below
        var dLon = deg2rad(lon2-lon1); 
        var a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2)
            ; 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        var d = R * c * 1000; // Distance in m
        return d;
    }
    
    function deg2rad(deg) {
    return deg * (Math.PI/180)
    }
</script>

<%- include ../partials/modal_map %>
   
